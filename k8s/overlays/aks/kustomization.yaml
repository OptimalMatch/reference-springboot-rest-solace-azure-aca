apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: solace-service

commonLabels:
  environment: aks
  platform: azure

bases:
  - ../../base

resources:
  - ../../azure/workload-identity.yaml
  - ../../azure/keyvault-provider.yaml
  - ../../azure/storage-class.yaml
  - ../../azure/ingress-appgw.yaml
  - ../../azure/azure-monitor.yaml

patches:
  # Update deployment to use Azure Workload Identity and Key Vault
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: solace-service
      spec:
        replicas: 3
        template:
          metadata:
            labels:
              azure.workload.identity/use: "true"
              aadpodidbinding: solace-service
          spec:
            serviceAccountName: solace-service-sa
            containers:
            - name: solace-service
              resources:
                requests:
                  memory: "1Gi"
                  cpu: "500m"
                limits:
                  memory: "2Gi"
                  cpu: "2000m"
              envFrom:
              - configMapRef:
                  name: app-insights-config
              volumeMounts:
              - name: secrets-store
                mountPath: "/mnt/secrets-store"
                readOnly: true
            volumes:
            - name: secrets-store
              csi:
                driver: secrets-store.csi.k8s.io
                readOnly: true
                volumeAttributes:
                  secretProviderClass: "solace-service-keyvault"

  # Update service with Azure-specific annotations
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: solace-service
        annotations:
          service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: "/actuator/health"

configMapGenerator:
  - name: solace-service-config
    behavior: merge
    literals:
      - SPRING_CLOUD_AZURE_ENABLED=true

images:
  - name: solace-service
    newName: ${ACR_NAME}.azurecr.io/solace-service
    newTag: latest

replacements:
  - source:
      kind: ConfigMap
      name: azure-config
      fieldPath: data.AZURE_CLIENT_ID
    targets:
      - select:
          kind: ServiceAccount
          name: solace-service-sa
        fieldPaths:
          - metadata.annotations.[azure.workload.identity/client-id]
